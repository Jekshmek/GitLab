<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="isc.git.GitLab">
<TimeCreated>64700,73518.498808</TimeCreated>

<Method name="getDir">
<ClassMethod>1</ClassMethod>
<CodeMode>expression</CodeMode>
<Implementation><![CDATA[##class(%File).NormalizeDirectory($system.Util.GetEnviron("CI_PROJECT_DIR"))
]]></Implementation>
</Method>

<Method name="getCommit">
<Description>
For CI build - get current commit</Description>
<ClassMethod>1</ClassMethod>
<CodeMode>expression</CodeMode>
<Implementation><![CDATA[$system.Util.GetEnviron("CI_COMMIT_SHA")
]]></Implementation>
</Method>

<Method name="load">
<Description>
Do a full load
do ##class(isc.git.GitLab).load()</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	try {
		set dir = ..getDir()
		do ..log("Importing dir " _ dir)
		do $system.OBJ.ImportDir(dir, ..getExtWildcard(), "c", .errors, 1)
		throw:$get(errors,0)'=0 ##class(%Exception.General).%New("Load error")
		
		do ..init()
		
		$$$TOE(sc, ##class(isc.git.Settings).setSetting("commit", ..getCommit()))
		
		halt
	} catch ex {
		write !,$System.Status.GetErrorText(ex.AsStatus()),!
		do $system.Process.Terminate(, 1)
	}
]]></Implementation>
</Method>

<Method name="loadDiff">
<Description>
Do a diff load
do ##class(isc.git.GitLab).loadDiff()</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	try {
		#dim sc,sc1 As %Status = $$$OK
		set oldCommit = ##class(isc.git.Settings).getSetting("commit")
		if (oldCommit="") {
			do ..log("Previous commit not found. Doing full load.")
			do ..load()
			halt
		} else {
			set dir = ..getDir()
			set newCommit = ..getCommit()
			do ..log("Importing dir " _ dir)
			do ..log($$$FormatText("Loading diff between %1 and %2", oldCommit, newCommit))
		}
		
		do ##class(isc.git.Diff).buildDiff(dir, oldCommit, newCommit, .modified, .added, .deleted)
		
		set modified = modified _ added
		do ..logVar(modified, "modified")
		set items = ""
		
		for i=1:1:$ll(modified) {
			set file = dir _ $lg(modified, i)
			set sc = $$$ADDSC(sc, $system.OBJ.Load(file,"", .errors, .item,,,,"UTF8"))
			merge items = item	
		}
	
		do ..logVar(.items, "items")
		set sc = $$$ADDSC(sc, $system.OBJ.CompileList(.items, "cuk /checkuptodate=expandedonly", .errors))
		
		// To-Do delete
		set deleteCode = ##class(isc.git.Settings).getSetting("delete")
		if (($ll(deleted)>0) && (deleteCode '="")) {
			do $classmethod($p(deleteCode, ":"), $p(deleteCode, ":", 2))
		}
				
		throw:$$$ISERR(sc) ##class(%Exception.StatusException).CreateFromStatus(sc)
		throw:$get(errors,0)'=0 ##class(%Exception.General).%New("Load error")
		
		do ..init()
		
		$$$TOE(sc, ##class(isc.git.Settings).setSetting("commit", ..getCommit()))
		
		$$$TOE(sc, $system.OBJ.Export(.items, dir _ "diff.xml"))
		
		halt
	} catch ex {
		do ..logException(ex)
		do $system.Process.Terminate(, 1)
	}
]]></Implementation>
</Method>

<Method name="init">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set init = ##class(isc.git.Settings).getSetting("init")
	if (init'="") {
		do ..log("Running init code: " _ init)
		do $classmethod($p(init, ":"), $p(init, ":", 2))
	} else {
		do ..log("No init code")
	}
]]></Implementation>
</Method>

<Method name="test">
<Description>
do ##class(isc.git.GitLab).test()</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	try {
		set tests = ##class(isc.git.Settings).getSetting("tests")
		if (tests'="") {
			set dir = ..getDir()
			set ^UnitTestRoot = dir
			
			$$$TOE(sc, ##class(%UnitTest.Manager).RunTest(tests, "/nodelete"))
			$$$TOE(sc, ..writeTestHTML())
			throw:'..isLastTestOk() ##class(%Exception.General).%New("Tests error")
		}
		halt
	} catch ex {
		do ..logException(ex)
		do $system.Process.Terminate(, 1)
	}
]]></Implementation>
</Method>

<Method name="package">
<Description>
do ##class(GitLab.Main).package()</Description>
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	try {
		set dir = ..getDir()
		// TODO
		do $system.OBJ.ExportAllClasses(dir _ "full.xml", , .errors)
		throw:$g(errors,0)'=0 ##class(%Exception.General).%New("Package error")
		halt
	} catch ex {
		do ..logException(ex)
		do $system.Process.Terminate(, 1)
	}
]]></Implementation>
</Method>

<Method name="writeTestHTML">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set text = ##class(%Dictionary.XDataDefinition).IDKEYOpen($classname(), "html").Data.Read()
	set text = $replace(text, "!!!", ..getURL())
	
	set file = ##class(%Stream.FileCharacter).%New()
	set name = ..getDir() _  "tests.html"
	do file.LinkToFile(name)
	do file.Write(text)
	quit file.%Save()
]]></Implementation>
</Method>

<Method name="getURL">
<ClassMethod>1</ClassMethod>
<Implementation><![CDATA[
	set url = ##class(isc.git.Settings).getSetting("url")
	set url = url _ $system.CSP.GetDefaultApp("%SYS")
	set url = url_"/%25UnitTest.Portal.Indices.cls?Index="_ $g(^UnitTest.Result, 1) _ "&$NAMESPACE=" _ $zconvert($namespace,"O","URL")
	quit url
]]></Implementation>
</Method>

<Method name="getExtWildcard">
<Description>
Get extensions as wildcard for import</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set extList = ##class(isc.git.Settings).getSetting("ext")
	set ext = "*." _ $lts(##class(isc.git.Settings).getSetting("ext"), ";*.")
	quit ext
]]></Implementation>
</Method>

<Method name="isLastTestOk">
<Description>
w ##class(GitLab.Main).isLastTestOk()</Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Boolean</ReturnType>
<Implementation><![CDATA[
	set in = ##class(%UnitTest.Result.TestInstance).%OpenId(^UnitTest.Result)
	for i=1:1:in.TestSuites.Count() {
		#dim suite As %UnitTest.Result.TestSuite
		set suite = in.TestSuites.GetAt(i)
		return:suite.Status=0 $$$NO
	}
	quit $$$YES
]]></Implementation>
</Method>

<XData name="html">
<Data><![CDATA[
<html lang="en-US">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="refresh" content="0; url=!!!"/>
<script type="text/javascript">
window.location.href = "!!!"
</script>
</head>
<body>
If you are not redirected automatically, follow this <a href='!!!'>link to tests</a>.
</body>
</html>
]]></Data>
</XData>

<Method name="logVar">
<ClassMethod>1</ClassMethod>
<FormalSpec>var="",name:%String=""</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	do ..log("Variable " _ name)
	zw var
	/*if $isObject(var) {
		zw var
	} elseif $listValid(var) {
		write $lts(var, ", ")
	} else {
		write var
	}*/
]]></Implementation>
</Method>

<Method name="logException">
<ClassMethod>1</ClassMethod>
<FormalSpec>ex:%Exception.AbstractException</FormalSpec>
<Implementation><![CDATA[	do ..logStatus(ex.AsStatus())
]]></Implementation>
</Method>

<Method name="logStatus">
<ClassMethod>1</ClassMethod>
<FormalSpec>sc:%Status</FormalSpec>
<Implementation><![CDATA[	do ..log($System.Status.GetErrorText(sc))
]]></Implementation>
</Method>

<Method name="log">
<ClassMethod>1</ClassMethod>
<FormalSpec>msg:%String</FormalSpec>
<Implementation><![CDATA[	write !, $$$FormatText("[%1] %2", $zdatetime($ztimestamp, 3, 1, 3), msg), !
]]></Implementation>
</Method>
</Class>
</Export>
